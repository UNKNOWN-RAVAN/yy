<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Study Portal â€” Complete</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    :root{
      --bg:#f8f9fa;
      --card:#ffffff;
      --text:#212529;
      --muted:#6c757d;
      --nav:#343a40;
    }
    body { background:var(--bg); color:var(--text); transition: background 0.25s, color 0.25s; }
    .dark-mode { --bg:#121416; --card:#1e1f22; --text:#e9ecef; --muted:#adb5bd; --nav:#0b0c0d; }
    .card { margin:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08); border:0; background:var(--card); }
    .navbar { background:var(--nav); }
    .navbar-brand { color:#fff; font-weight:600; }
    .btn-video { background:#0d6efd; color:#fff; border:0; }
    .btn-video:hover { background:#0b5ed7; color:#fff; }
    .btn-pdf { margin-right:6px; }
    #topicList li { cursor:pointer; user-select:none; }
    .completed { text-decoration:line-through; color:green; opacity:0.9; }
    .topic-has-pdf::after { content:" ðŸ“„"; margin-left:6px; }
    .small-muted { color:var(--muted); font-size:0.9rem; }
    .controls { gap:8px; display:flex; align-items:center; }
    .badge-completed { background:green; color:#fff; }
    .badge-total { background:#6; }
    .no-data { padding:40px; text-align:center; color:var(--muted); }
    @media (max-width:767px){
      .navbar .form-control.w-25 { width:40% !important; }
    }
  </style>
</head>
<body>
  <nav class="navbar py-2">
    <div class="container-fluid d-flex align-items-center">
      <span class="navbar-brand">ðŸ“š Study Portal</span>

      <div class="ms-auto d-flex align-items-center controls">
        <label class="mb-0 small-muted me-2">Load JSON</label>
        <input type="file" id="jsonFile" accept=".json" class="form-control w-25" />
        <button id="toggleMode" class="btn btn-light ms-2">ðŸŒ™</button>
        <button id="exportCache" class="btn btn-success ms-2">â¬‡ Export Cache</button>
        <label class="mb-0 small-muted ms-2 me-1">Import Cache</label>
        <input type="file" id="importCache" class="form-control w-25" />
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-3">
    <div class="row">
      <!-- Sidebar -->
      <aside class="col-md-2 bg-light p-3" id="sidebar">
        <div class="d-flex align-items-center mb-2">
          <h6 class="mb-0">Topics</h6>
          <div class="ms-auto small-muted" id="topicCounts"></div>
        </div>

        <input type="text" id="searchTopic" class="form-control mb-2" placeholder="Search topic or id..." />
        <div class="mb-2 d-flex gap-2">
          <button id="showAll" class="btn btn-sm btn-outline-primary">All</button>
          <button id="showCompleted" class="btn btn-sm btn-outline-success">Completed</button>
          <button id="showPending" class="btn btn-sm btn-outline-secondary">Pending</button>
        </div>

        <ul id="topicList" class="list-group" style="max-height:65vh; overflow:auto;"></ul>
      </aside>

      <!-- Main Content -->
      <main class="col-md-10">
        <div id="videoGrid" class="row"></div>
        <div id="noData" class="no-data d-none">Load a JSON file to see topics, videos and PDFs.</div>
      </main>
    </div>
  </div>

<script>
/* -------------------------
   Data & Cache (IDs only)
   ------------------------- */
let jsonData = null;
let cache = Array.isArray(JSON.parse(localStorage.getItem("studyCache") || "[]"))
  ? JSON.parse(localStorage.getItem("studyCache") || "[]")
  : []; // store only completed video IDs as array

/* -------------------------
   UI Elements
   ------------------------- */
const jsonFileEl = document.getElementById("jsonFile");
const importCacheEl = document.getElementById("importCache");
const exportCacheBtn = document.getElementById("exportCache");
const toggleModeBtn = document.getElementById("toggleMode");
const topicListEl = document.getElementById("topicList");
const videoGridEl = document.getElementById("videoGrid");
const searchTopicEl = document.getElementById("searchTopic");
const noDataEl = document.getElementById("noData");
const topicCountsEl = document.getElementById("topicCounts");
const showAllBtn = document.getElementById("showAll");
const showCompletedBtn = document.getElementById("showCompleted");
const showPendingBtn = document.getElementById("showPending");

/* -------------------------
   Dark Mode Toggle
   ------------------------- */
toggleModeBtn.addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
});

/* -------------------------
   Load JSON file (content list)
   ------------------------- */
jsonFileEl.addEventListener("change", function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt){
    try {
      const parsed = JSON.parse(evt.target.result);
      // Basic validation
      if(!parsed.batches || !Array.isArray(parsed.batches) || parsed.batches.length === 0){
        alert("Invalid JSON structure: 'batches' array missing.");
        return;
      }
      jsonData = parsed;
      const topics = getAllTopics();
      renderTopicList(topics);
      noDataEl.classList.add("d-none");
      // auto-open first topic if exists
      if(topics.length) loadContent(topics[0]);
    } catch (err) {
      alert("Failed to parse JSON: " + err.message);
    }
  };
  reader.readAsText(file);
});

/* -------------------------
   Helpers: topics aggregation
   ------------------------- */
function getAllTopics(){
  if(!jsonData) return [];
  const topics = [];
  jsonData.batches.forEach(batch => {
    if(Array.isArray(batch.topics)){
      batch.topics.forEach(t => topics.push(t));
    }
  });
  return topics;
}

/* -------------------------
   Render Sidebar Topics
   - show topic index, topic_id
   - mark if PDFs exist
   - show completed count / total videos
   ------------------------- */
function renderTopicList(topics){
  topicListEl.innerHTML = "";
  topics.forEach((topic, idx) => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-start";
    const left = document.createElement("div");
    left.className = "ms-1 me-auto";
    const title = document.createElement("div");
    title.className = "fw-bold";
    // show topic label: if topic has a name property use it, else show index + id
    const topicLabel = topic.title || topic.name || `Topic ${idx+1} â€” ${topic.topic_id || ''}`;
    title.textContent = topicLabel;
    if(Array.isArray(topic.pdfs) && topic.pdfs.length) title.classList.add("topic-has-pdf");

    const sub = document.createElement("div");
    sub.className = "small-muted";
    const totalVideos = Array.isArray(topic.videos) ? topic.videos.length : 0;
    const completedCount = Array.isArray(topic.videos)
      ? topic.videos.filter(v => cache.includes(v.id)).length
      : 0;
    sub.textContent = `${completedCount}/${totalVideos} videos done`;

    left.appendChild(title);
    left.appendChild(sub);

    const right = document.createElement("div");
    right.className = "d-flex flex-column align-items-end";
    const openBtn = document.createElement("button");
    openBtn.className = "btn btn-sm btn-outline-primary";
    openBtn.textContent = "Open";
    openBtn.onclick = () => loadContent(topic);

    right.appendChild(openBtn);

    li.appendChild(left);
    li.appendChild(right);

    // click anywhere on li opens topic
    li.addEventListener("click", (ev) => {
      // avoid double-trigger when clicking the Open button
      if(ev.target === openBtn) return;
      loadContent(topic);
    });

    topicListEl.appendChild(li);
  });

  // update counts
  const totalTopics = topics.length;
  const totalVideos = topics.reduce((s,t) => s + (Array.isArray(t.videos) ? t.videos.length : 0), 0);
  const totalCompleted = topics.reduce((s,t) => s + (Array.isArray(t.videos) ? t.videos.filter(v => cache.includes(v.id)).length : 0), 0);
  topicCountsEl.textContent = `${totalCompleted}/${totalVideos}`;
}

/* -------------------------
   Search & Filters
   ------------------------- */
searchTopicEl.addEventListener("input", function(){
  const q = this.value.trim().toLowerCase();
  [...topicListEl.children].forEach(li => {
    const txt = li.textContent.toLowerCase();
    li.style.display = txt.includes(q) ? "" : "none";
  });
});

showAllBtn.addEventListener("click", () => {
  [...topicListEl.children].forEach(li => li.style.display = "");
});
showCompletedBtn.addEventListener("click", () => {
  [...topicListEl.children].forEach(li => {
    const txt = li.textContent;
    // parse completed/total from subtext
    const match = txt.match(/(\d+)\/(\d+)\s+videos/);
    if(match){
      const done = parseInt(match[1],10), total = parseInt(match[2],10);
      li.style.display = (total>0 && done === total) ? "" : "none";
    } else {
      li.style.display = "none";
    }
  });
});
showPendingBtn.addEventListener("click", () => {
  [...topicListEl.children].forEach(li => {
    const txt = li.textContent;
    const match = txt.match(/(\d+)\/(\d+)\s+videos/);
    if(match){
      const done = parseInt(match[1],10), total = parseInt(match[2],10);
      li.style.display = (total>0 && done < total) ? "" : "none";
    } else {
      li.style.display = "none";
    }
  });
});

/* -------------------------
   Load Content (videos + pdfs together)
   - videos first, then pdfs
   - each item is a card in grid
   ------------------------- */
function loadContent(topic){
  videoGridEl.innerHTML = "";
  if(!topic) return;

  // Title row
  const headerCol = document.createElement("div");
  headerCol.className = "col-12 mb-2";
  headerCol.innerHTML = `
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <h5 class="mb-0">${topic.title || topic.name || `Topic â€” ${topic.topic_id || ''}`}</h5>
        <div class="small-muted">Topic ID: ${topic.topic_id || 'â€”'}</div>
      </div>
      <div class="d-flex gap-2">
        <button id="markAll" class="btn btn-sm btn-outline-success">Mark all videos done</button>
        <button id="unmarkAll" class="btn btn-sm btn-outline-secondary">Unmark all</button>
      </div>
    </div>
  `;
  videoGridEl.appendChild(headerCol);

  // Videos
  if(Array.isArray(topic.videos) && topic.videos.length){
    topic.videos.forEach(v => {
      const isCompleted = cache.includes(v.id);
      const col = document.createElement("div");
      col.className = "col-md-4 col-sm-6";
      col.innerHTML = `
        <div class="card h-100">
          <div class="card-body ${isCompleted ? 'completed' : ''}">
            <h6 class="card-title">${escapeHtml(v.name || 'Untitled Video')}</h6>
            <div class="mb-2 small-muted">Video ID: ${escapeHtml(v.id || '')}</div>
            <div class="d-flex gap-2 flex-wrap">
              <a target="_blank" rel="noopener noreferrer" class="btn btn-video btn-sm"
                href="${buildPlayerUrl(v)}">â–¶ Play Video</a>
              <button class="btn btn-sm btn-outline-secondary" data-id="${escapeHtml(v.id || '')}">${isCompleted ? 'Unmark' : 'Mark Completed'}</button>
            </div>
            ${v.description ? `<p class="mt-2 small-muted">${escapeHtml(v.description)}</p>` : ''}
          </div>
        </div>
      `;
      // attach toggle handler
      const temp = document.createElement('div');
      temp.appendChild(col);
      const toggleBtn = temp.querySelector('button[data-id]');
      toggleBtn.addEventListener('click', () => toggleCompleted(v.id, topic));
      videoGridEl.appendChild(col);
    });
  }

  // PDFs
  if(Array.isArray(topic.pdfs) && topic.pdfs.length){
    topic.pdfs.forEach(p => {
      const col = document.createElement("div");
      col.className = "col-md-4 col-sm-6";
      col.innerHTML = `
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title">${escapeHtml(p.name || 'PDF')}</h6>
            <div class="mb-2 small-muted">PDF</div>
            <div class="d-flex gap-2">
              <a class="btn btn-sm btn-success btn-pdf" href="${escapeAttr(p.link)}" target="_blank" rel="noopener noreferrer">Download PDF</a>
              <a class="btn btn-sm btn-warning btn-pdf" href="https://www.selectionway.com/js/pdfjs/web/viewer.html?file=${encodeURIComponent(p.link)}" target="_blank" rel="noopener noreferrer">View PDF</a>
            </div>
          </div>
        </div>
      `;
      videoGridEl.appendChild(col);
    });
  }

  // If no items
  if((!Array.isArray(topic.videos) || topic.videos.length === 0) && (!Array.isArray(topic.pdfs) || topic.pdfs.length === 0)){
    const col = document.createElement("div");
    col.className = "col-12";
    col.innerHTML = `<div class="card"><div class="card-body"><div class="no-data">No videos or PDFs in this topic.</div></div></div>`;
    videoGridEl.appendChild(col);
  }

  // Mark all / Unmark all handlers
  document.getElementById("markAll").onclick = () => {
    if(Array.isArray(topic.videos)){
      topic.videos.forEach(v => {
        if(!cache.includes(v.id)) cache.push(v.id);
      });
      saveCache();
      loadContent(topic);
      renderTopicList(getAllTopics());
    }
  };
  document.getElementById("unmarkAll").onclick = () => {
    if(Array.isArray(topic.videos)){
      const ids = topic.videos.map(v => v.id);
      cache = cache.filter(id => !ids.includes(id));
      saveCache();
      loadContent(topic);
      renderTopicList(getAllTopics());
    }
  };
}

/* -------------------------
   Build player URL (include token if present)
   - safe encoding
   ------------------------- */
function buildPlayerUrl(v){
  // default player base (user had used ssc-cgl-paid.vercel.app/player.html)
  const base = "https://ssc-cgl-paid.vercel.app/player.html";
  const params = new URLSearchParams();
  if(v.link) params.set("url", v.link);
  if(v.token) params.set("token", v.token);
  // include name for display in player
  const name = (v.name ? v.name + " VISHAL RAVAN" : "Video VISHAL RAVAN");
  params.set("name", name);
  return base + "?" + params.toString();
}

/* -------------------------
   Toggle Completed (IDs only)
   ------------------------- */
function toggleCompleted(id, topicForReload){
  if(!id) return;
  if(cache.includes(id)){
    cache = cache.filter(x => x !== id);
  } else {
    cache.push(id);
  }
  saveCache();
  // reload current topic if provided, else refresh sidebar
  if(topicForReload) loadContent(topicForReload);
  renderTopicList(getAllTopics());
}

/* -------------------------
   Save cache to localStorage
   ------------------------- */
function saveCache(){
  localStorage.setItem("studyCache", JSON.stringify(cache));
}

/* -------------------------
   Export / Import cache (IDs array)
   ------------------------- */
exportCacheBtn.addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(cache)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "cache.json";
  a.click();
  URL.revokeObjectURL(a.href);
});

importCacheEl.addEventListener("change", function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt){
    try {
      const parsed = JSON.parse(evt.target.result);
      if(!Array.isArray(parsed)) throw new Error("Cache file must be a JSON array of IDs.");
      cache = parsed;
      saveCache();
      alert("Cache imported successfully.");
      // refresh UI if JSON loaded
      if(jsonData) renderTopicList(getAllTopics());
    } catch(err){
      alert("Failed to import cache: " + err.message);
    }
  };
  reader.readAsText(file);
});

/* -------------------------
   Utilities: escape HTML/attributes
   ------------------------- */
function escapeHtml(str){
  if(!str && str !== 0) return "";
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'", "&#39;");
}
function escapeAttr(s){ return escapeHtml(s); }

/* -------------------------
   Initial UI state
   ------------------------- */
(function init(){
  // show counts if any
  if(jsonData) renderTopicList(getAllTopics());
  else {
    topicListEl.innerHTML = `<li class="list-group-item small-muted">No JSON loaded</li>`;
    noDataEl.classList.remove("d-none");
  }
})();
</script>
</body>
</html>