<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAVAN Dashboard - Token Login</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #0f172a;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Telegram Popup */
        .telegram-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .telegram-box {
            background: linear-gradient(135deg, #0088cc 0%, #006699 100%);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 50px rgba(0, 136, 204, 0.4);
            border: 3px solid white;
            animation: popupScale 0.5s ease-out;
        }

        @keyframes popupScale {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .telegram-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .telegram-box h2 {
            color: white;
            font-size: 28px;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .telegram-box p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.6;
        }

        .channel-link {
            display: inline-block;
            background: white;
            color: #0088cc;
            padding: 15px 30px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .channel-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
        }

        .proceed-btn {
            background: transparent;
            border: 2px solid white;
            color: white;
            padding: 12px 40px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .proceed-btn:hover {
            background: white;
            color: #0088cc;
        }

        /* Update Screen - FIXED LOGIC */
        .update-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            padding: 20px;
        }

        .update-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
            border: 3px solid #7c3aed;
        }

        .app-logo {
            width: 120px;
            height: 120px;
            border-radius: 25px;
            object-fit: cover;
            margin-bottom: 20px;
            border: 5px solid #e2e8f0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .update-box h2 {
            color: #1e293b;
            font-size: 28px;
            margin-bottom: 15px;
        }

        .update-box p {
            color: #64748b;
            margin-bottom: 25px;
            font-size: 16px;
            line-height: 1.6;
        }

        .version-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
        }

        .version-info span {
            font-weight: bold;
            color: #7c3aed;
        }

        .update-btn {
            background: linear-gradient(135deg, #7c3aed 0%, #3b82f6 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            box-shadow: 0 8px 20px rgba(124, 58, 237, 0.3);
            transition: all 0.3s ease;
        }

        .update-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(124, 58, 237, 0.4);
        }

        .force-update-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
        }

        .force-update-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(239, 68, 68, 0.4);
        }

        .force-message {
            color: #ef4444;
            font-weight: bold;
            margin-top: 15px;
            padding: 10px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .optional-message {
            color: #10b981;
            font-weight: bold;
            margin-top: 15px;
            padding: 10px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .social-link {
            display: inline-block;
            margin-top: 15px;
            color: #3b82f6;
            text-decoration: none;
            font-weight: 600;
            font-size: 15px;
        }

        .continue-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }

        .continue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
        }

        /* Header Styles */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #7c3aed 0%, #3b82f6 100%);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 25px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .user-details {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
            border: 4px solid white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .role-badge {
            padding: 8px 25px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .role-owner {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .role-admin {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .role-user {
            background: linear-gradient(45deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        /* Grid Styles */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
            margin-top: 40px;
        }

        @media (max-width: 1200px) {
            .grid-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .grid-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        /* Batch Card Styles */
        .batch-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .batch-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .batch-logo-container {
            width: 100%;
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 30px;
        }

        .batch-logo {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            object-fit: cover;
            border: 6px solid white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .batch-content {
            padding: 25px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .batch-name {
            font-size: 22px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .batch-link {
            display: inline-block;
            margin-top: auto;
            padding: 12px 30px;
            background: linear-gradient(135deg, #7c3aed 0%, #3b82f6 100%);
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.3);
            border: none;
            cursor: pointer;
            width: 100%;
            text-align: center;
        }

        .batch-link:hover {
            background: linear-gradient(135deg, #6d28d9 0%, #2563eb 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(124, 58, 237, 0.4);
        }

        /* Login Section */
        .login-section {
            background: white;
            border-radius: 20px;
            padding: 50px;
            max-width: 500px;
            margin: 50px auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .login-section h2 {
            text-align: center;
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .login-subtitle {
            text-align: center;
            color: #64748b;
            margin-bottom: 40px;
            font-size: 16px;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn.active {
            color: #7c3aed;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #7c3aed 0%, #3b82f6 100%);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #334155;
            font-weight: 600;
            font-size: 15px;
        }

        .form-group input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .form-group input:focus {
            outline: none;
            border-color: #7c3aed;
            background: white;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #7c3aed 0%, #3b82f6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.3);
        }

        .login-btn:hover {
            background: linear-gradient(135deg, #6d28d9 0%, #2563eb 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(124, 58, 237, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* Error/Success Messages */
        .error-message {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
        }

        .success-message {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        /* Controls */
        .logout-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        .refresh-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* Admin Panel */
        .admin-panel {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .admin-panel h3 {
            color: #1e293b;
            margin-bottom: 25px;
            font-size: 22px;
            text-align: center;
        }

        .admin-form {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
        }

        @media (max-width: 900px) {
            .admin-form {
                grid-template-columns: 1fr;
            }
        }

        .form-row {
            display: flex;
            flex-direction: column;
        }

        .form-row label {
            margin-bottom: 10px;
            color: #334155;
            font-weight: 600;
            font-size: 15px;
        }

        .form-row input {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            background: #f8fafc;
            transition: all 0.3s ease;
        }

        .form-row input:focus {
            outline: none;
            border-color: #7c3aed;
            background: white;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .submit-btn {
            grid-column: 1 / -1;
            padding: 18px;
            background: linear-gradient(135deg, #7c3aed 0%, #3b82f6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.3);
        }

        .submit-btn:hover {
            background: linear-gradient(135deg, #6d28d9 0%, #2563eb 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(124, 58, 237, 0.4);
        }

        /* Empty State */
        .no-batches {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 20px;
            grid-column: 1 / -1;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .no-batches h3 {
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .no-batches p {
            color: #64748b;
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: white;
            font-size: 20px;
            grid-column: 1 / -1;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #94a3b8;
            font-size: 14px;
            border-top: 1px solid #334155;
        }
    </style>
</head>
<body>
    <!-- Telegram Channel Popup -->
    <div id="telegramPopup" class="telegram-popup">
        <div class="telegram-box">
            <div class="telegram-icon">üì¢</div>
            <h2>Join Our Channel First!</h2>
            <p>Join our official Telegram channel for latest updates, announcements and support. It's mandatory to join before using the dashboard.</p>
            
            <a href="https://t.me/unk" target="_blank" class="channel-link">
                üîó Join @ALL BATCH Channel
            </a>
            
            <p style="margin-top: 20px; font-size: 14px; color: rgba(255,255,255,0.8);">
                After joining, click below to proceed
            </p>
            
            <button class="proceed-btn" onclick="proceedToApp()">
                ‚úÖ I've Joined, Proceed
            </button>
        </div>
    </div>

    <!-- Update Screen - SHOW ONLY WHEN VERSION MISMATCH -->
    <div id="updateScreen" class="update-screen hidden">
        <div class="update-box">
            <img id="updateImage" class="app-logo" src="" alt="App Logo">
            <h2 id="updateTitle">App Update Available</h2>
            
            <div class="version-info">
                Your version: <span id="currentVersion">2.4.0</span><br>
                Latest version: <span id="latestVersion">2.5.0</span>
            </div>
            
            <p id="updateMessage">Please update the app to enjoy new features and improvements.</p>
            
            <button id="updateButton" class="update-btn" onclick="openUpdateLink()">
                üîÑ Update Now
            </button>
            
            <!-- Show UPDATE Button only when force_update is true -->
            <button id="forceUpdateButton" class="force-update-btn hidden" onclick="openUpdateLink()">
                ‚ö†Ô∏è UPDATE Required
            </button>
            
            <!-- Show Continue button only when force_update is false -->
            <button id="continueButton" class="continue-btn hidden" onclick="continueWithoutUpdate()">
                üöÄ Continue Anyway
            </button>
            
            <div id="forceUpdateMessage" class="force-message hidden">
                ‚ö†Ô∏è UPDATE Required! You must update to continue.
            </div>
            
            <div id="optionalUpdateMessage" class="optional-message hidden">
                üí° Optional Update Available - You can continue without updating
            </div>
            
            <a id="socialLink" href="#" target="_blank" class="social-link">
                üì± Follow for more updates
            </a>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="hidden">
        <div class="container">
            <!-- Login Section -->
            <div id="loginSection" class="login-section">
                <h2>üîê RAVAN Dashboard</h2>
                <p class="login-subtitle">Login with credentials or token</p>
                
                <div class="login-tabs">
                    <button class="tab-btn active" onclick="switchTab('credential')">Credentials</button>
                    <button class="tab-btn" onclick="switchTab('token')">Token Login</button>
                </div>
                
                <!-- Credential Login -->
                <div id="credentialTab" class="login-form">
                    <div id="errorMessage" class="error-message hidden"></div>
                    <div id="successMessage" class="success-message hidden"></div>
                    
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" id="username" placeholder="Enter username" value="RAVI">
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="password" id="password" placeholder="Enter password" value="KUMAR">
                    </div>
                    <button class="login-btn" onclick="loginWithCredentials()" id="credentialBtn">
                        Login with Credentials
                    </button>
                </div>
                
                <!-- Token Login -->
                <div id="tokenTab" class="login-form hidden">
                    <div id="tokenErrorMessage" class="error-message hidden"></div>
                    <div class="form-group">
                        <label for="tokenInput">JWT Token:</label>
                        <textarea id="tokenInput" placeholder="Paste your JWT token here..." rows="5"></textarea>
                    </div>
                    <button class="login-btn" onclick="loginWithToken()" id="tokenBtn">
                        Login with Token
                    </button>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboardSection" class="hidden">
                <div class="header">
                    <h1>üöÄ RAVAN Dashboard</h1>
                    <p class="login-subtitle" style="color: rgba(255,255,255,0.9); margin-bottom: 0;">
                        Welcome to your dashboard
                    </p>
                    <div class="user-info">
                        <div class="user-details">
                            <div class="avatar" id="userAvatar">R</div>
                            <div>
                                <h2 id="userName">RAVI BHAI</h2>
                                <div id="userRole" class="role-badge role-user">user</div>
                            </div>
                        </div>
                        <div class="button-group">
                            <button class="refresh-btn" onclick="loadUserData()">
                                üîÑ Refresh
                            </button>
                            <button class="logout-btn" onclick="logout()">
                                üö™ Logout
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Admin Panel -->
                <div id="adminPanel" class="admin-panel hidden">
                    <h3>üõ†Ô∏è Admin Controls</h3>
                    <div class="admin-form">
                        <div class="form-row">
                            <label for="batchName">Batch Name:</label>
                            <input type="text" id="batchName" placeholder="CAREERWILL">
                        </div>
                        <div class="form-row">
                            <label for="batchLink">Website Domain:</label>
                            <input type="text" id="batchLink" placeholder="ravan-80.vercel.app">
                        </div>
                        <div class="form-row">
                            <label for="batchImage">Image URL:</label>
                            <input type="text" id="batchImage" placeholder="example.com/my.png">
                        </div>
                        <button class="submit-btn" onclick="addNewBatch()">
                            ‚ûï Add New Batch
                        </button>
                    </div>
                </div>

                <!-- Batches Grid -->
                <div class="grid-container" id="batchesGrid">
                    <div class="loading">
                        <p>Loading your batches...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // App Configuration
        const APP_VERSION = '2.4.0';
        const JSON_CONFIG_URL = 'https://yy-pi-three.vercel.app/App/Control.json';
        const TELEGRAM_CHANNEL = 'https://t.me/unk';
        
        let jsonData = null;
        let currentUser = null;
        let userToken = null;
        let telegramJoined = false;
        let updateLink = '';

        // Proceed after Telegram join
        function proceedToApp() {
            telegramJoined = true;
            document.getElementById('telegramPopup').classList.add('hidden');
            checkAppVersion();
        }

        // Check app version from JSON - FIXED LOGIC
        async function checkAppVersion() {
            try {
                const response = await fetch(JSON_CONFIG_URL);
                jsonData = await response.json();
                
                const appConfig = jsonData.app;
                const latestVersion = appConfig.version;
                const forceUpdate = appConfig.force_update;
                updateLink = appConfig.update_link;
                
                // Update UI with JSON data
                document.getElementById('updateImage').src = appConfig.image;
                document.getElementById('updateTitle').textContent = appConfig.title;
                document.getElementById('updateMessage').textContent = appConfig.message;
                document.getElementById('latestVersion').textContent = latestVersion;
                document.getElementById('currentVersion').textContent = APP_VERSION;
                document.getElementById('socialLink').href = appConfig.social_link;
                
                // CRITICAL FIX: Only show update screen when versions DON'T match
                if (APP_VERSION !== latestVersion) {
                    console.log('Version mismatch detected:', APP_VERSION, '!=', latestVersion);
                    document.getElementById('updateScreen').classList.remove('hidden');
                    
                    if (forceUpdate) {
                        // UPDATE - User MUST update
                        document.getElementById('forceUpdateMessage').classList.remove('hidden');
                        document.getElementById('forceUpdateButton').classList.remove('hidden');
                        document.getElementById('updateButton').classList.add('hidden');
                        document.getElementById('continueButton').classList.add('hidden');
                        document.getElementById('optionalUpdateMessage').classList.add('hidden');
                        document.getElementById('appContainer').classList.add('hidden'); // Hide app
                    } else {
                        // Optional Update - User can skip
                        document.getElementById('optionalUpdateMessage').classList.remove('hidden');
                        document.getElementById('updateButton').classList.remove('hidden');
                        document.getElementById('continueButton').classList.remove('hidden');
                        document.getElementById('forceUpdateButton').classList.add('hidden');
                        document.getElementById('forceUpdateMessage').classList.add('hidden');
                        document.getElementById('appContainer').classList.add('hidden'); // Hide app initially
                    }
                } else {
                    console.log('Version matches:', APP_VERSION, '==', latestVersion);
                    // Versions match - show app directly, no update screen
                    document.getElementById('updateScreen').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    checkLoginStatus();
                }
            } catch (error) {
                console.error('Error fetching JSON:', error);
                // If JSON fails, show app anyway
                document.getElementById('updateScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                checkLoginStatus();
            }
        }

        // Open update link
        function openUpdateLink() {
            if (updateLink) {
                window.open(updateLink, '_blank');
            }
        }

        // Continue without updating
        function continueWithoutUpdate() {
            document.getElementById('updateScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            checkLoginStatus();
        }

        // Parse batch data from JSON
        function parseBatchDataFromJson() {
            if (!jsonData || !jsonData.websites) return [];
            
            return jsonData.websites.sort((a, b) => a.priority - b.priority).map(website => ({
                link: website.link,
                name: website.name,
                image: website.image
            }));
        }

        // Display batches from JSON
        function displayBatchesFromJson() {
            const gridContainer = document.getElementById('batchesGrid');
            const batches = parseBatchDataFromJson();
            
            if (!batches || batches.length === 0) {
                gridContainer.innerHTML = `
                    <div class="no-batches">
                        <h3>üì≠ No Batches Available</h3>
                        <p>You don't have access to any batches yet.</p>
                        <p>Contact your admin for access.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            batches.forEach((batch, index) => {
                html += `
                    <div class="batch-card" onclick="openLink('${batch.link}')">
                        <div class="batch-logo-container">
                            <img src="${batch.image}" 
                                 alt="${batch.name}" 
                                 class="batch-logo"
                                 onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(batch.name)}&background=7c3aed&color=fff&size=200&bold=true'">
                        </div>
                        <div class="batch-content">
                            <h3 class="batch-name">${batch.name}</h3>
                            <button class="batch-link" onclick="event.stopPropagation(); openLink('${batch.link}')">
                                üåê Visit Website
                            </button>
                        </div>
                    </div>
                `;
            });

            gridContainer.innerHTML = html;
        }

        // Original functions from your code
        function switchTab(tab) {
            const credentialTab = document.getElementById('credentialTab');
            const tokenTab = document.getElementById('tokenTab');
            const tabs = document.querySelectorAll('.tab-btn');
            
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'credential') {
                credentialTab.classList.remove('hidden');
                tokenTab.classList.add('hidden');
                document.querySelector('.tab-btn:first-child').classList.add('active');
            } else {
                credentialTab.classList.add('hidden');
                tokenTab.classList.remove('hidden');
                document.querySelector('.tab-btn:last-child').classList.add('active');
            }
        }

        async function loginWithCredentials() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            const btn = document.getElementById('credentialBtn');

            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                errorDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = 'Logging in...';
                errorDiv.classList.add('hidden');
                
                const response = await fetch('https://ravan-system.vercel.app/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Login failed');
                }

                if (!data.token.endsWith('@unk')) {
                    throw new Error('Invalid token ');
                }

                userToken = data.token;
                currentUser = {
                    username: data.username,
                    name: data.name,
                    role: data.role,
                    allowedBatches: data.allowedBatches || []
                };

                localStorage.setItem('RAVAN_token', userToken);
                localStorage.setItem('RAVAN_user', JSON.stringify(currentUser));

                successDiv.textContent = `Welcome ${data.name}!`;
                successDiv.classList.remove('hidden');

                setTimeout(() => {
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('dashboardSection').classList.remove('hidden');
                    loadUserData();
                }, 1000);

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Login with Credentials';
            }
        }

        function loginWithToken() {
            const token = document.getElementById('tokenInput').value.trim();
            const errorDiv = document.getElementById('tokenErrorMessage');
            const btn = document.getElementById('tokenBtn');

            if (!token) {
                errorDiv.textContent = 'Please paste your JWT token';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                if (!token.endsWith('@unk')) {
                    throw new Error('Invalid token format. Token must end with @unk');
                }

                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT token format');
                }

                const payload = JSON.parse(atob(parts[1]));
                
                currentUser = {
                    username: payload.username || '',
                    name: payload.name || 'User',
                    role: payload.role || 'user',
                    allowedBatches: payload.allowedBatches || []
                };

                userToken = token;

                localStorage.setItem('RAVAN_token', userToken);
                localStorage.setItem('RAVAN_user', JSON.stringify(currentUser));

                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                loadUserData();

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        function loadUserData() {
            try {
                const userData = JSON.parse(localStorage.getItem('RAVAN_user'));
                if (!userData) {
                    logout();
                    return;
                }

                document.getElementById('userName').textContent = userData.name;
                document.getElementById('userAvatar').textContent = userData.name.charAt(0);
                
                const roleBadge = document.getElementById('userRole');
                roleBadge.textContent = userData.role;
                roleBadge.className = `role-badge role-${userData.role}`;

                if (userData.role === 'admin' || userData.role === 'owner') {
                    document.getElementById('adminPanel').classList.remove('hidden');
                } else {
                    document.getElementById('adminPanel').classList.add('hidden');
                }

                displayBatchesFromJson();

            } catch (error) {
                console.error('Error loading user data:', error);
                logout();
            }
        }

        function openLink(url) {
            if (url && url !== '#') {
                window.open(url, '_blank');
            }
        }

        function logout() {
            localStorage.removeItem('RAVAN_token');
            localStorage.removeItem('RAVAN_user');
            currentUser = null;
            userToken = null;
            
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('tokenErrorMessage').classList.add('hidden');
            
            switchTab('credential');
        }

        function addNewBatch() {
            const name = document.getElementById('batchName').value.trim();
            const link = document.getElementById('batchLink').value.trim();
            const image = document.getElementById('batchImage').value.trim();

            if (!name || !link) {
                alert('Please enter Batch Name and Website Domain');
                return;
            }

            const batchString = `${link}=${name}=${image}`;
            
            const userData = JSON.parse(localStorage.getItem('RAVAN_user'));
            if (userData) {
                userData.allowedBatches = userData.allowedBatches || [];
                userData.allowedBatches.push(batchString);
                localStorage.setItem('RAVAN_user', JSON.stringify(userData));
                
                loadUserData();
                
                document.getElementById('batchName').value = '';
                document.getElementById('batchLink').value = '';
                document.getElementById('batchImage').value = '';
                
                alert(`Batch "${name}" added successfully!\n\nFormat: ${link}=${name}=${image}`);
            }
        }

        // Check if already logged in
        function checkLoginStatus() {
            const token = localStorage.getItem('RAVAN_token');
            const user = localStorage.getItem('RAVAN_user');
            
            if (token && user) {
                if (!token.endsWith('@unk')) {
                    localStorage.removeItem('RAVAN_token');
                    localStorage.removeItem('RAVAN_user');
                    return;
                }
                
                currentUser = JSON.parse(user);
                userToken = token;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                loadUserData();
            }
        }

        // Initialize
        window.onload = function() {
            // Show Telegram popup first
            document.getElementById('telegramPopup').classList.remove('hidden');
            
            // Check login status after Telegram join
            setTimeout(() => {
                if (telegramJoined) {
                    checkLoginStatus();
                }
            }, 100);
            
            // Enter key support
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginWithCredentials();
                }
            });
            
            document.getElementById('tokenInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    loginWithToken();
                }
            });
        };
    </script>
</body>
</html>